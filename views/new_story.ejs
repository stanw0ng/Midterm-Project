<%- include('partials/_header', {title: "New Story - Open Book" }); %>
  <main id="new-story">
    <h2>New Story</h2>

    <!-- This will be the page where the users will write their new story -->
    <form method="POST" id="draft" action="/story/new">
      <label for="storyTitle">Story Title</label>
      <input type="text" name="storyTitle" id="story-title">

      <label for="description">Description</label>
      <input type="text" name="description">

      <div>
        <label for="category">Category</label>
        <select name="category">
          <option value="Free Prose">Free Prose</option>
          <option value="Poetry">Poetry</option>
          <option value="Other">Other</option>
        </select>

        <label for="genre">Genre</label>
        <select name="genre">
          <option value="Fiction">Fiction</option>
          <option value="Mystery">Mystery</option>
          <option value="Horror">Horror</option>
          <option value="Fantasy">Fantasy</option>
          <option value="Science Fiction">Science Fiction</option>
          <option value="Other">Other</option>
        </select>

        <label for="rating">Rating</label>
        <select name="rating">
          <option value="G">G</option>
          <option value="PG">PG</option>
          <option value="PG-13">PG-13</option>
          <option value="R">R</option>
          <option value="N/A">N/A</option>
        </select>
      </div>

      <label for="chapterTitle">Chapter Title</label>
      <input type="text" name="chapterTitle">
      <%- include('partials/_text_editor') %>
        <div>
          <button id="save-story">Save</button>
          <button id="publish">Publish</button>
          <button id="discard-story">Discard</button>
        </div>
        <div id="success" class="hidden notification">

        </div>
        <div id="fail" class="hidden notification">

        </div>

    </form>

  </main>
  <script>
    /**
     * Updates the web page title with passed parameter, or defaults to "New Story";
     */
    const updateTitle = function(title) {
      const text = title || "New Story";
      $(document).attr('title', `${text} - Open Book`);
    };

    $(document).ready(function() {
      const $title = $('#story-title');
      updateTitle($title.val());

      const $notifications = $('.notification');
      $notifications.hide();
      $notifications.removeClass('hidden');

      const $success = $('#success');
      const $fail = $('#fail');

      $('input').keydown(function(event) {
        if (event.keyCode == 13) {
          event.preventDefault();
          return false;
        }
      });

      $(document).submit(function() {
        event.preventDefault();
      });

      $title.on('focusout', () => {
        updateTitle($title.val());
      });

      $('#save-story').on('click', function() {
        $notifications.slideUp();
        const body = $('#draft').serialize();
        $.post('/story/save/', body, function(data, status) {
          if (data) {
            $success.html(data);
            $success.slideDown();
            return;
          }
          $fail.html('Something went wrong with saving your new story. We apologize for the inconvenience.');
          $fail.slideDown();
        });
      });

      $('#discard-story').on('click', function() {
        $notifications.slideUp();
        $.post('/story/discard/', function(result, status) {
          if (result) {
            window.location.href = "/read";
            return;
          };
          $fail.html('Something went wrong with discarding your draft. We apologize for the inconvenience.');
          $fail.slideDown();
        });
      });

    });

  </script>

  <%- include('partials/_footer'); %>
