<%- include('partials/_header', {title: "Open Book" }); %>

  <div class="container">
    <div class="contributions-box">
      <% if (storyStatus[0].completed===true) { %>
        <div class="contribution stop">The story is complete, nothing more to say!</div>
        <% } else { %>
          <div class="contribution plus">+ Add Contribution</div>
          <% } %>
            <% contributions.forEach(contribution=> { %>
              <div class="contribution entry" data-contribution-id="<%= contribution.contributions_id %>">
                <div>
                  <%= contribution.title %>
                </div>
                <div>By: <%= contribution.name %>
                </div>
                <div>Published: <%= contribution.publish_date %>
                </div>
                <div id="<%= contribution.contributions_id %>">
                  <%= contribution.upvotes %>
                    <%= contribution.upvotes==='1' ? 'Upvote' : 'Upvotes' %>
                </div>
                <div>
                  <% if(!upvotes.includes(contribution.contributions_id)) { %>
                    <button class="upvote-btn" data-contribution-id="<%= contribution.contributions_id %>">Upvote</button>
                  <% } else { %>
                    <button class="upvote-btn" data-contribution-id="<%= contribution.contributions_id %>">Upvoted</button>
                  <% } %>
                </div>
              </div>
              <% }); %>
    </div>
  </div>

  <script>
    $(document).ready(function() {

      $('.plus').click(function() {
        window.location.href = `/contribute/<%= storyId %>`;
      });

      // $('.entry').click(function(event) {
      //   if ($(this).hasClass('stop')) {
      //     event.preventDefault();
      //   } else {
      //     const contributionID = $(this).attr('data-contribution-id');
      //     window.location.href = `/contribution/${contributionID}`;
      //   }
      // });
      const $button = $('.upvote-btn');

      $button.click(function() {

        //Make a reference to the button we push
        const $thisButton = $(this);
        const upvoteID = $thisButton.attr('data-contribution-id');

        $.post(`/read/upvote/`, { upvoteID }, function(upvotes, status) {
          if (upvotes !== undefined) {
            const tail = upvotes === 1 ? 'Upvote' : 'Upvotes';

            //Get button's HTML
            const label = $thisButton.html();
            $thisButton.html(label === "Upvote" ? "Upvoted" : "Upvote");

            $(`#${upvoteID}`).html(`${upvotes} ${tail}`);
          }
        });
      });

    });
  </script>

  <%- include('partials/_footer'); %>
