<%- include('partials/_header', {title: "Edit Story - Open Book" }); %>
  <main id="story-editor">
    <h2>Edit Story</h2>

    <!-- This will be the page where the users will write their new story -->
    <form method="POST" id="draft" action="/manage/update/<%= story_id %>">
      <label for="storyTitle">Story Title</label>
      <input type="text" name="storyTitle" id="story-title" value="<%= story_title %>">

      <label for="description">Description</label>
      <input type="text" name="description" value="<%= description %>">

      <div>
        <label for="category">Category</label>
        <select id="category" value="<%= category %>" name="category">
          <option value="Free Prose">Free Prose</option>
          <option value="Poetry">Poetry</option>
          <option value="Other">Other</option>
        </select>

        <label for="genre">Genre</label>
        <select id="genre" name="genre" value="<%= genre %>">
          <option value="Fiction">Fiction</option>
          <option value="Mystery">Mystery</option>
          <option value="Horror">Horror</option>
          <option value="Fantasy">Fantasy</option>
          <option value="Science Fiction">Science Fiction</option>
          <option value="Other">Other</option>
        </select>

        <label for="rating">Rating</label>
        <select id="rating" value="<%= age_rating %>" name="rating">
          <option value="G">G</option>
          <option value="PG">PG</option>
          <option value="PG-13">PG-13</option>
          <option value="R">R</option>
          <option value="N/A">N/A</option>
        </select>
      </div>

      <label for="chapterTitle">Chapter Title</label>
      <input type="text" name="chapterTitle" value="<%= chapter_title %>">
      <%- include('partials/_text_editor'), { body } %>
        <div>
          <button id="update-story">Update</button>
          <button id="discard-changes">Discard Changes</button>
        </div>
        <div id="success" class="hidden notification">

        </div>
        <div id="fail" class="hidden notification">

        </div>

    </form>

  </main>
  <script>
    $(document).ready(function() {

      const category = $('#category').attr('value');
      const genre = $('#genre').attr('value');
      const rating = $('#rating').attr('value');
      $(`option[value='${category}']`).prop('selected', true);
      $(`option[value='${genre}']`).prop('selected', true);
      $(`option[value='${rating}']`).prop('selected', true);

      const $title = $('#story-title');
      updateTitle($title.val());

      const $notifications = $('.notification');
      $notifications.hide();
      $notifications.removeClass('hidden');

      const $success = $('#success');
      const $fail = $('#fail');

      $('input').keydown(function(event) {
        if (event.keyCode == 13) {
          event.preventDefault();
          return false;
        }
      });

      $(document).submit(function() {
        event.preventDefault();
      });

      $title.on('focusout', () => {
        updateTitle($title.val());
      });

      $('#update-story').on('click', function() {
        $notifications.slideUp();
        updateStory($success, $fail);
      });

      $('#discard-changes').on('click', function() {
        window.location.href = `/read`;
      });

    });

    const updateTitle = function(title) {
      const text = title || "New Story";
      $(document).attr('title', `${text} - Open Book`);
    };

    /**
     * Handles the post request for saving and publishing new story
     */
    const updateStory = function(success, fail) {
      const $draft = $('#draft');
      const body = $draft.serialize();
      const address = $draft.attr('action');
      $.post(address, body, function(data, status) {
        if (data) {
          window.location.href = `/read`;
          return;
        }
        fail.html('Something went wrong with updating story. We apologize for the inconvenience.').slideDown();
    });
    };

  </script>

  <%- include('partials/_footer'); %>
